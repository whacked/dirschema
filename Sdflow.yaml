./internal/cli/version.go:
  in: Sdflow.yaml
  out: internal/cli/version.go
  run: |
    today=$(date +%Y%m%d)
    git_commits_today=$(git log --pretty=format:"%cd %h" --date=format:"%Y%m%d" | tac | grep "^$today" || true)
    if [ -z "$git_commits_today" ]; then
      number_commits_today=0
      latest_sha=$(git rev-parse --short HEAD)
    else
      number_commits_today=$(echo "$git_commits_today" | wc -l | tr -d ' ')
      latest_sha=$(echo "$git_commits_today" | tail -1 | awk '{print $NF}')
    fi

    cat > $out << EOF
    package cli

    const Version = "$today.$number_commits_today.$latest_sha"
    EOF

./default.nix:
  in:
    - ./internal/cli/version.go
    - ./default.nix
  run: |
    version_string=$(cat ${in.0} | tail -1 | awk '{print $NF}' | tr -d '"')
    current_default_nix=$(cat ${in.1})
    echo -e "$current_default_nix" | sed -E 's|version\s+=.+;|version = "'$version_string'";|' | tee ${in.1}

update-version:
  in:
    - ./default.nix
    - ./internal/cli/version.go

./bin/dirschema:
  in:
    - internal/**/*.go
    - cmd/**/*.go
  run: mkdir -p bin && go build -o $out ./cmd/dirschema

build:
  in: ./bin/dirschema


test-spec-files:
  in:
    root: ./testdata/simple_valid/root/
    dsl_dict: ./testdata/simple_valid/spec-dict.yaml
    dsl_list: ./testdata/simple_valid/spec-list.yaml
    exact_json: ./testdata/simple_valid/spec.json
    pattern_json: ./testdata/simple_valid/spec-raw-schema.json
    fail_root: ./testdata/invalid_glob_no_match/root/
    fail_spec: ./testdata/invalid_glob_no_match/spec.yaml
  run: |
    echo === ${in.dsl_dict} ===
    dirschema validate --root ${in.root} ${in.dsl_dict}
    echo === ${in.dsl_list} ===
    dirschema validate --root ${in.root} ${in.dsl_list}
    echo === ${in.exact_json} ===
    dirschema validate --root ${in.root} ${in.exact_json}
    echo === ${in.pattern_json} ===
    dirschema validate --root ${in.root} ${in.pattern_json}
    echo === ${in.fail_spec} \(expect failure\) ===
    if dirschema validate --root ${in.fail_root} ${in.fail_spec}; then
      echo "FAIL: expected validation error for glob with no match"
      exit 1
    else
      echo "OK: correctly rejected (glob has no match)"
    fi
