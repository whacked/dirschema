./version.go:
  in: Sdflow.yaml
  out: internal/cli/version.go
  run: |
    today=$(date +%Y%m%d)
    git_commits_today=$(git log --pretty=format:"%cd %h" --date=format:"%Y%m%d" | tac | grep "^$today" || true)
    if [ -z "$git_commits_today" ]; then
      number_commits_today=0
      latest_sha=$(git rev-parse --short HEAD)
    else
      number_commits_today=$(echo "$git_commits_today" | wc -l | tr -d ' ')
      latest_sha=$(echo "$git_commits_today" | tail -1 | awk '{print $NF}')
    fi

    cat > $out << EOF
    package cli

    const Version = "$today.$number_commits_today.$latest_sha"
    EOF

./default.nix:
  in:
    - ./version.go
    - ./default.nix
  run: |
    version_string=$(cat ${in.0} | tail -1 | awk '{print $NF}' | tr -d '"')
    current_default_nix=$(cat ${in.1})
    echo -e "$current_default_nix" | sed -E 's|version\s+=.+;|version = "'$version_string'";|' | tee ${in.1}

update-version:
  in:
    - ./default.nix
    - ./version.go

dirschema:
  in:
    - internal/**/*.go
    - cmd/**/*.go
  out: dirschema
  run: go build -o $out ./cmd/dirschema
